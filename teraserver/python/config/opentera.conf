

location / {
    proxy_pass http://127.0.0.1:4040;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /;
    proxy_set_header    X-SSL-CERT          $ssl_client_cert;
    proxy_set_header    X-SSL-VERIFIED      $ssl_client_verify;
    proxy_set_header    X-SSL-CLIENT-DN     $ssl_client_s_dn;
    proxy_set_header    X-SSL-ISSUER-DN     $ssl_client_i_dn;
}

location /wss {
    proxy_read_timeout 30s;
    proxy_pass http://127.0.0.1:4040/wss;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

location /log/ {
    proxy_pass          http://127.0.0.1:4041/;
    proxy_redirect      http://$host/  https://$host:$server_port/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /log;
}

location /file/ {
    proxy_pass          http://127.0.0.1:4042/;
    proxy_redirect      http://$host/  https://$host:$server_port/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /file;
}


location /bureau/ {
    proxy_pass          http://127.0.0.1:4050/;
    proxy_redirect      http://$host/  https://$host:$server_port/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /bureau;
}

location /rehab/ {
    proxy_pass          http://127.0.0.1:4070/;
    proxy_redirect      http://$host/ https://$host:$server_port/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /rehab;
}

location /robot/ {
    proxy_pass          http://127.0.0.1:4080/;
    proxy_redirect      http://$host/ https://$host:$server_port/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /robot;
}

########################################################################################################################
# webrtc on port 8080
########################################################################################################################
location /webrtc/8080/ {
    resolver 127.0.0.1;
    set $proxy_webrtc_port 8080;

    # Match port in uri
    if ($uri ~ "^/webrtc/([0-9]+)/.*$")
    {
        set $proxy_webrtc_port $1;
        rewrite ^/webrtc/[0-9]+/(.*)$ /$1 break;
    }
    #proxy_pass http://127.0.0.1:$proxy_webrtc_port/;
    proxy_pass http://127.0.0.1:8080/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /webrtc/;
}

location /websocket/8080/ {
    resolver 127.0.0.1;
    set $proxy_websocket_port 8080;

    # Match port in url
    if ($uri ~ "^/websocket/([0-9]+)/.*$")
    {
        set $proxy_websocket_port $1;
        rewrite ^/websocket/[0-9]+/(.*)$ /websocket/$proxy_websocket_port/$1 break;
    }

    #proxy_pass http://127.0.0.1:$proxy_websocket_port/;
    proxy_pass http://127.0.0.1:8080/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
########################################################################################################################

########################################################################################################################
# webrtc on port 8081
########################################################################################################################
location /webrtc/8081/ {
    resolver 127.0.0.1;
    set $proxy_webrtc_port 8081;

    # Match port in uri
    if ($uri ~ "^/webrtc/([0-9]+)/.*$")
    {
        set $proxy_webrtc_port $1;
        rewrite ^/webrtc/[0-9]+/(.*)$ /$1 break;
    }
    #proxy_pass http://127.0.0.1:$proxy_webrtc_port/;
    proxy_pass http://127.0.0.1:8081/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /webrtc/;
}

location /websocket/8081/ {
    resolver 127.0.0.1;
    set $proxy_websocket_port 8081;

    # Match port in url
    if ($uri ~ "^/websocket/([0-9]+)/.*$")
    {
        set $proxy_websocket_port $1;
        rewrite ^/websocket/[0-9]+/(.*)$ /websocket/$proxy_websocket_port/$1 break;
    }

    #proxy_pass http://127.0.0.1:$proxy_websocket_port/;
    proxy_pass http://127.0.0.1:8081/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
########################################################################################################################

########################################################################################################################
# webrtc on port 8082
########################################################################################################################
location /webrtc/8082/ {
    resolver 127.0.0.1;
    set $proxy_webrtc_port 8082;

    # Match port in uri
    if ($uri ~ "^/webrtc/([0-9]+)/.*$")
    {
        set $proxy_webrtc_port $1;
        rewrite ^/webrtc/[0-9]+/(.*)$ /$1 break;
    }
    #proxy_pass http://127.0.0.1:$proxy_webrtc_port/;
    proxy_pass http://127.0.0.1:8082/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /webrtc/;
}

location /websocket/8082/ {
    resolver 127.0.0.1;
    set $proxy_websocket_port 8082;

    # Match port in url
    if ($uri ~ "^/websocket/([0-9]+)/.*$")
    {
        set $proxy_websocket_port $1;
        rewrite ^/websocket/[0-9]+/(.*)$ /websocket/$proxy_websocket_port/$1 break;
    }

    #proxy_pass http://127.0.0.1:$proxy_websocket_port/;
    proxy_pass http://127.0.0.1:8082/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
########################################################################################################################

########################################################################################################################
# webrtc on port 8083
########################################################################################################################
location /webrtc/8083/ {
    resolver 127.0.0.1;
    set $proxy_webrtc_port 8083;

    # Match port in uri
    if ($uri ~ "^/webrtc/([0-9]+)/.*$")
    {
        set $proxy_webrtc_port $1;
        rewrite ^/webrtc/[0-9]+/(.*)$ /$1 break;
    }
    #proxy_pass http://127.0.0.1:$proxy_webrtc_port/;
    proxy_pass http://127.0.0.1:8083/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /webrtc/;
}

location /websocket/8083/ {
    resolver 127.0.0.1;
    set $proxy_websocket_port 8083;

    # Match port in url
    if ($uri ~ "^/websocket/([0-9]+)/.*$")
    {
        set $proxy_websocket_port $1;
        rewrite ^/websocket/[0-9]+/(.*)$ /websocket/$proxy_websocket_port/$1 break;
    }

    #proxy_pass http://127.0.0.1:$proxy_websocket_port/;
    proxy_pass http://127.0.0.1:8083/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
########################################################################################################################

########################################################################################################################
# webrtc on port 8084
########################################################################################################################
location /webrtc/8084/ {
    resolver 127.0.0.1;
    set $proxy_webrtc_port 8084;

    # Match port in uri
    if ($uri ~ "^/webrtc/([0-9]+)/.*$")
    {
        set $proxy_webrtc_port $1;
        rewrite ^/webrtc/[0-9]+/(.*)$ /$1 break;
    }
    #proxy_pass http://127.0.0.1:$proxy_webrtc_port/;
    proxy_pass http://127.0.0.1:8084/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /webrtc/;
}

location /websocket/8084/ {
    resolver 127.0.0.1;
    set $proxy_websocket_port 8084;

    # Match port in url
    if ($uri ~ "^/websocket/([0-9]+)/.*$")
    {
        set $proxy_websocket_port $1;
        rewrite ^/websocket/[0-9]+/(.*)$ /websocket/$proxy_websocket_port/$1 break;
    }

    #proxy_pass http://127.0.0.1:$proxy_websocket_port/;
    proxy_pass http://127.0.0.1:8084/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
########################################################################################################################

########################################################################################################################
# webrtc on port 8085
########################################################################################################################
location /webrtc/8085/ {
    resolver 127.0.0.1;
    set $proxy_webrtc_port 8085;

    # Match port in uri
    if ($uri ~ "^/webrtc/([0-9]+)/.*$")
    {
        set $proxy_webrtc_port $1;
        rewrite ^/webrtc/[0-9]+/(.*)$ /$1 break;
    }
    #proxy_pass http://127.0.0.1:$proxy_webrtc_port/;
    proxy_pass http://127.0.0.1:8085/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /webrtc/;
}

location /websocket/8085/ {
    resolver 127.0.0.1;
    set $proxy_websocket_port 8085;

    # Match port in url
    if ($uri ~ "^/websocket/([0-9]+)/.*$")
    {
        set $proxy_websocket_port $1;
        rewrite ^/websocket/[0-9]+/(.*)$ /websocket/$proxy_websocket_port/$1 break;
    }

    #proxy_pass http://127.0.0.1:$proxy_websocket_port/;
    proxy_pass http://127.0.0.1:8085/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
########################################################################################################################

########################################################################################################################
# webrtc on port 8086
########################################################################################################################
location /webrtc/8086/ {
    resolver 127.0.0.1;
    set $proxy_webrtc_port 8086;

    # Match port in uri
    if ($uri ~ "^/webrtc/([0-9]+)/.*$")
    {
        set $proxy_webrtc_port $1;
        rewrite ^/webrtc/[0-9]+/(.*)$ /$1 break;
    }
    #proxy_pass http://127.0.0.1:$proxy_webrtc_port/;
    proxy_pass http://127.0.0.1:8086/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /webrtc/;
}

location /websocket/8086/ {
    resolver 127.0.0.1;
    set $proxy_websocket_port 8086;

    # Match port in url
    if ($uri ~ "^/websocket/([0-9]+)/.*$")
    {
        set $proxy_websocket_port $1;
        rewrite ^/websocket/[0-9]+/(.*)$ /websocket/$proxy_websocket_port/$1 break;
    }

    #proxy_pass http://127.0.0.1:$proxy_websocket_port/;
    proxy_pass http://127.0.0.1:8086/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
########################################################################################################################

########################################################################################################################
# webrtc on port 8087
########################################################################################################################
location /webrtc/8087/ {
    resolver 127.0.0.1;
    set $proxy_webrtc_port 8087;

    # Match port in uri
    if ($uri ~ "^/webrtc/([0-9]+)/.*$")
    {
        set $proxy_webrtc_port $1;
        rewrite ^/webrtc/[0-9]+/(.*)$ /$1 break;
    }
    #proxy_pass http://127.0.0.1:$proxy_webrtc_port/;
    proxy_pass http://127.0.0.1:8087/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /webrtc/;
}

location /websocket/8087/ {
    resolver 127.0.0.1;
    set $proxy_websocket_port 8087;

    # Match port in url
    if ($uri ~ "^/websocket/([0-9]+)/.*$")
    {
        set $proxy_websocket_port $1;
        rewrite ^/websocket/[0-9]+/(.*)$ /websocket/$proxy_websocket_port/$1 break;
    }

    #proxy_pass http://127.0.0.1:$proxy_websocket_port/;
    proxy_pass http://127.0.0.1:8087/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
########################################################################################################################

########################################################################################################################
# webrtc on port 8088
########################################################################################################################
location /webrtc/8088/ {
    resolver 127.0.0.1;
    set $proxy_webrtc_port 8088;

    # Match port in uri
    if ($uri ~ "^/webrtc/([0-9]+)/.*$")
    {
        set $proxy_webrtc_port $1;
        rewrite ^/webrtc/[0-9]+/(.*)$ /$1 break;
    }
    #proxy_pass http://127.0.0.1:$proxy_webrtc_port/;
    proxy_pass http://127.0.0.1:8088/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /webrtc/;
}

location /websocket/8088/ {
    resolver 127.0.0.1;
    set $proxy_websocket_port 8088;

    # Match port in url
    if ($uri ~ "^/websocket/([0-9]+)/.*$")
    {
        set $proxy_websocket_port $1;
        rewrite ^/websocket/[0-9]+/(.*)$ /websocket/$proxy_websocket_port/$1 break;
    }

    #proxy_pass http://127.0.0.1:$proxy_websocket_port/;
    proxy_pass http://127.0.0.1:8088/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
########################################################################################################################

########################################################################################################################
# webrtc on port 8089
########################################################################################################################
location /webrtc/8089/ {
    resolver 127.0.0.1;
    set $proxy_webrtc_port 8089;

    # Match port in uri
    if ($uri ~ "^/webrtc/([0-9]+)/.*$")
    {
        set $proxy_webrtc_port $1;
        rewrite ^/webrtc/[0-9]+/(.*)$ /$1 break;
    }
    #proxy_pass http://127.0.0.1:$proxy_webrtc_port/;
    proxy_pass http://127.0.0.1:8089/;
    proxy_set_header 	X-ExternalPort      $server_port;
    proxy_set_header 	X-ExternalHost      $host;
    proxy_set_header   	Host                $host;
    proxy_set_header   	X-Real-IP           $remote_addr;
    proxy_set_header   	X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header   	X-Forwarded-Proto   $scheme;
    proxy_set_header	X-Scheme            $scheme;
    proxy_set_header 	X-Script-Name       /webrtc/;
}

location /websocket/8089/ {
    resolver 127.0.0.1;
    set $proxy_websocket_port 8089;

    # Match port in url
    if ($uri ~ "^/websocket/([0-9]+)/.*$")
    {
        set $proxy_websocket_port $1;
        rewrite ^/websocket/[0-9]+/(.*)$ /websocket/$proxy_websocket_port/$1 break;
    }

    #proxy_pass http://127.0.0.1:$proxy_websocket_port/;
    proxy_pass http://127.0.0.1:8089/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}
########################################################################################################################

########################################################################################################################
# webrtc_teleop on port defined in url tilda means will have regexp,
########################################################################################################################
location ~ ^/webrtc_teleop/(.*)$ {

    # Here is a tool to help you debug these regular expressions https://regex101.com/

    # Match if do not end with index.html or .css or .js
    rewrite     ^/webrtc_teleop/([0-9]+)/((?!index.html).*(?<!\.css|\.js))$     /signaling_server/$1/index.html last;

    # Match if end with js/*.js or css css/*.css
    rewrite     ^/webrtc_teleop/([0-9]+)/.*((?>js|css)/.*\.(?>css|js))$         /signaling_server/$1/$2 last;

    # Redirection to the proxy
    rewrite     ^/webrtc_teleop/(.*)$                                           /signaling_server/$1$is_args$args last;

    return 403;
}

location ~ ^/signaling_server/(.*)$ {
    proxy_pass http://127.0.0.1:$1$is_args$args;
    proxy_set_header    X-ExternalPort      $server_port;
    proxy_set_header    X-ExternalHost      $host;
    proxy_set_header    Host                $host;
    proxy_set_header    X-Real-IP           $remote_addr;
    proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto   $scheme;
    proxy_set_header    X-Scheme            $scheme;
    proxy_set_header    X-Script-Name       /webrtc_teleop/;

    # Websocket upgrades
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
}

